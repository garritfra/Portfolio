<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>Server-Side Caching with Apollo GraphQL</title><meta name="Description" content="Generalist developer writing about fullstack development, system administration and free software."/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="webmention" href="https://webmention.io/garrit.xyz/webmention"/><link rel="pingback" href="https://webmention.io/garrit.xyz/xmlrpc"/><link href="https://cdn.jsdelivr.net/npm/shareon@2/dist/shareon.min.css" rel="stylesheet"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/01aabd1b94e46386.css" as="style"/><link rel="stylesheet" href="/_next/static/css/01aabd1b94e46386.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-73b8966a3c579ab0.js" defer=""></script><script src="/_next/static/chunks/main-fbe9c9f0314b4cf5.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6a5aef4f0d1820ee.js" defer=""></script><script src="/_next/static/chunks/392-ae98e607f8861be3.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bpost%5D-4b0f6895d60d74a1.js" defer=""></script><script src="/_next/static/vpzYAEFlprTw_kfbsfyAn/_buildManifest.js" defer=""></script><script src="/_next/static/vpzYAEFlprTw_kfbsfyAn/_ssgManifest.js" defer=""></script></head><body><div id="__next"><section class="layout"><header class="header"><nav class="nav" role="navigation" aria-label="main navigation"><div class="header__container"><a href="/" class="header__container__logo underlined">Garrit&#x27;s Notes</a></div><ul class="header__links"><li><a href="/posts" class="underlined">Blog</a></li><li><a href="/contact" class="underlined">Contact</a></li><li><a href="/cv" class="underlined">Resume</a></li></ul></nav></header><div class="content"><article class="page h-entry"><div class="page__info"><h1 class="p-name">Server-Side Caching with Apollo GraphQL</h1><time class="page__info__date">Oct 04 2021</time></div><div class="page__body e-content"><p>I recently implemented server-side caching for one of our applications at work.
This guide tries to document that I&#x27;ve learned. It assumes that you are using
an apollo server of version 3 or higher.</p>
<h3 id="what-is-server-side-caching?" level="3">What is Server-Side Caching?</h3>
<p>The point of server-side caching is to reduce the load of your database by
“remembering” the results of a query for a certain period. If the exact same
query comes in again, that remembered result will be returned.</p>
<p>Caching should be handled with care. You should never enable caching for your
entire application. Instead, you should identify the bottlenecks and develop a
strategy to overcome them.</p>
<h3 id="enabling-caching-on-the-server" level="3">Enabling caching on the server</h3>
<p>The Apollo Team has done a great job
<a href="https://www.apollographql.com/docs/apollo-server/performance/caching/">documenting</a>
the caching behavior of their server. To add caching to your existing
Apollo-Server, you first have to add the <code>responseCachePlugin</code> to your
configuration as shown
<a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#caching-with-responsecacheplugin-advanced">here</a>:</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-js" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#cc7832">import</span><span> </span><span class="token imports">responseCachePlugin</span><span> </span><span class="token module" style="color:#cc7832">from</span><span> </span><span class="token" style="color:#6a8759">&quot;apollo-server-plugin-response-cache&quot;</span><span class="token" style="color:#a9b7c6">;</span><span>
</span>
<span></span><span class="token" style="color:#cc7832">const</span><span> server </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">new</span><span> </span><span class="token class-name">ApolloServer</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>	</span><span class="token" style="color:#808080">// ...other options...</span><span>
</span><span>	</span><span class="token literal-property" style="color:#9876aa">plugins</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#ffc66d">responseCachePlugin</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span></span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span></code></div></pre>
<p>Then, you have to configure a cache backend. By default, Apollo Server will
store the caches in RAM, but I’d recommend <a href="https://www.apollographql.com/docs/apollo-server/data/data-sources/#using-memcachedredis-as-a-cache-storage-backend">using
Redis</a>
(or Memcached, if you like), especially if your application is spread across
multiple instances of the same backend.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-js" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#cc7832">const</span><span> </span><span class="token" style="color:#a9b7c6">{</span><span> </span><span class="token maybe-class-name">BaseRedisCache</span><span> </span><span class="token" style="color:#a9b7c6">}</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#ffc66d">require</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;apollo-server-cache-redis&quot;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span><span>
</span><span></span><span class="token" style="color:#cc7832">const</span><span> </span><span class="token maybe-class-name">Redis</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#ffc66d">require</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;ioredis&quot;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span><span>
</span>
<span></span><span class="token" style="color:#cc7832">const</span><span> server </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">new</span><span> </span><span class="token class-name">ApolloServer</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>	</span><span class="token" style="color:#808080">// ...</span><span>
</span><span>	</span><span class="token literal-property" style="color:#9876aa">cache</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#cc7832">new</span><span> </span><span class="token class-name">BaseRedisCache</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>		</span><span class="token literal-property" style="color:#9876aa">plugins</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#ffc66d">responseCachePlugin</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span>		</span><span class="token literal-property" style="color:#9876aa">client</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#cc7832">new</span><span> </span><span class="token class-name">Redis</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>			</span><span class="token literal-property" style="color:#9876aa">host</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;redis-server&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span>		</span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span>	</span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span></span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span></code></div></pre>
<blockquote>
<p>Note that you have to use the ioredis library here. node_redis is deprecated
as of v2.6.0 of apollo-server-cache-redis.</p>
</blockquote>
<p>If everything went well, your server should now know how to cache responses!
This alone won’t get you very far, since it doesn’t know what to cache.</p>
<h3 id="telling-apollo-what-to-cache" level="3">Telling Apollo what to cache</h3>
<p>To make a type cachable, you have to declare <strong>cache hints</strong>. These properties
can either be set in the
<a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#in-your-resolvers-dynamic">resolver</a>,
or
<a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#in-your-schema-static">statically</a>
in the schema. To keep it simple, this guide will stick to the static method.
Feel free to experiment with the dynamic approach though!</p>
<p>To enable cache hints, simply add the following directive to your schema (you
only have to do this once):</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-gql" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>enum CacheControlScope {
</span>	PUBLIC
<!-- -->	PRIVATE
<!-- -->}
<!-- -->
<!-- -->directive @cacheControl(
<!-- -->	maxAge: Int
<!-- -->	scope: CacheControlScope
<!-- -->	inheritMaxAge: Boolean
<!-- -->) on FIELD_DEFINITION | OBJECT | INTERFACE | UNION</code></div></pre>
<p>Now you can add the <code>@cacheControl</code> directive to every type that should be cached.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-gql" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span># This type will be cached for 30 seconds
</span>type Post @cacheControl(maxAge: 30) {
<!-- -->	id: ID!
<!-- -->	title: String
<!-- -->	author: Author
<!-- -->	comments: [Comment]
<!-- -->}</code></div></pre>
<p>For security reasons, these conditions are <a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#why-are-these-the-maxage-defaults">very
strict</a>:</p>
<blockquote>
<p>Our philosophy behind Apollo Server caching is that a response should only be
considered cacheable if every part of that response opts in to being
cacheable.</p>
</blockquote>
<p>This means that every type needs to explicitly decide how long it should be
cached. According to this note, the example above actually won’t be cached at
all!</p>
<p>Having to specify the <code>maxAge</code> of every type would be tedious, so the authors
have come up with the <code>inheritMaxAge</code> property, which allows the type to
inherit the settings from its parent. So, in order to make our example
cachable, we have to enable cache control for all its subfields, either by
setting the <code>maxAge</code> explicitly or by inheriting it from the parent:</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-gql" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>type Post @cacheControl(maxAge: 30) {
</span>	id: ID!
<!-- -->	title: String
<!-- -->	author: Author
<!-- -->	comments: [Comment]
<!-- -->}
<!-- -->
<!-- -->type Author @cacheControl(inheritMaxAge: true) {
<!-- -->	id: ID!
<!-- -->	name: String
<!-- -->}
<!-- -->
<!-- -->type Comment @cacheControl(inheritMaxAge: true) {
<!-- -->	id: ID!
<!-- -->	body: String
<!-- -->}</code></div></pre>
<p>Now, whenever you query a <code>Post</code>, it will be thrown in the cache. If you query
the type again within 30 seconds, the query resolver won’t execute. Instead, it
will be read from the cache. Keep in mind that cache hints can also be set on
<code>query</code> and <code>mutation</code> fields. This can be handy if you want to cache the
entire response of a request.</p>
<h3 id="gotcha-1:-multiple-response-variations" level="3">Gotcha 1: Multiple Response Variations</h3>
<p>The use-case where this topic first came up required us to have different
responses based on the type of the logged in user. An <code>Admin</code> should see a
different result than a <code>Visitor</code>. If you ignore this fact, it could be that a
visitor could see the cache result of a query previously executed by an admin!</p>
<p>This problem can be counteracted by setting extra information in the cache key
via <code>extraCacheKeyData</code> (see
<a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#configuring-reads-and-writes">this</a>
paragraph):</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-js" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token literal-property" style="color:#9876aa">plugins</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#a9b7c6">[</span><span>
</span><span>    </span><span class="token" style="color:#ffc66d">responseCachePlugin</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>        </span><span class="token function-variable" style="color:#ffc66d">extraCacheKeyData</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#a9b7c6">(</span><span class="token parameter">ctx</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token arrow" style="color:#a9b7c6">=&gt;</span><span> </span><span class="token" style="color:#a9b7c6">(</span><span>
</span><span>            ctx</span><span class="token" style="color:#a9b7c6">.</span><span class="token property-access">context</span><span class="token" style="color:#a9b7c6">.</span><span class="token property-access">auth</span><span class="token" style="color:#a9b7c6">.</span><span class="token property-access">isAdmin</span><span>
</span><span>        </span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span>    </span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span></span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span></code></div></pre>
<p>This example can create two distinct caches: One for users that are marked as
admins, and one for regular users.</p>
<h3 id="gotcha-2:-user-specific-caches" level="3">Gotcha 2: User-specific caches</h3>
<p>Besides caching for a group of users, you can also cache responses <a href="https://www.apollographql.com/docs/apollo-server/performance/caching/#identifying-users-for-private-responses">for every
user
individually</a>.
You may have noticed that you can also set a <code>scope</code> field in the cache control
directive. This will only cache the response if a user is logged in:</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-gql" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>type Post {
</span>	id: ID!
<!-- -->	title: String
<!-- -->	author: Author @cacheControl(maxAge: 10, scope: PRIVATE)
<!-- -->}</code></div></pre>
<p>Apollo determines if a user is logged in or not, based on if the <code>sessionId</code>
function has returned a value other than <code>null</code>.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-js" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#cc7832">import</span><span> </span><span class="token imports">responseCachePlugin</span><span> </span><span class="token module" style="color:#cc7832">from</span><span> </span><span class="token" style="color:#6a8759">&quot;apollo-server-plugin-response-cache&quot;</span><span class="token" style="color:#a9b7c6">;</span><span>
</span><span></span><span class="token" style="color:#cc7832">const</span><span> server </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">new</span><span> </span><span class="token class-name">ApolloServer</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>	</span><span class="token" style="color:#808080">// ...other settings...</span><span>
</span><span>	</span><span class="token literal-property" style="color:#9876aa">plugins</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#a9b7c6">[</span><span>
</span><span>		</span><span class="token" style="color:#ffc66d">responseCachePlugin</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span>			</span><span class="token function-variable" style="color:#ffc66d">sessionId</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#a9b7c6">(</span><span class="token parameter">requestContext</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token arrow" style="color:#a9b7c6">=&gt;</span><span>
</span><span>				requestContext</span><span class="token" style="color:#a9b7c6">.</span><span class="token property-access">request</span><span class="token" style="color:#a9b7c6">.</span><span class="token property-access">http</span><span class="token" style="color:#a9b7c6">.</span><span class="token property-access">headers</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">get</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;sessionid&quot;</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#a9b7c6">||</span><span> </span><span class="token null nil" style="color:#cc7832">null</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span>		</span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span>	</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span></span><span class="token" style="color:#a9b7c6">}</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span></code></div></pre>
<p>I’m unsure how effective this pattern is, since every user will receive its key
in the cache. This kind of defeats the purpose of server-side caching, which is
meant to reduce load on the database. If you’re trying to cache fields for
individual users, you might also want to take a look at client-side caching via
<a href="https://github.com/appmotion/apollo-augmented-hooks">apollo-augmented-hooks</a>.</p>
<p>This is post 020 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p><hr/><p><a href="mailto:garrit@slashdev.space?subject=Re: Server-Side%20Caching%20with%20Apollo%20GraphQL">Reply via E-Mail</a></p><a href="https://www.buymeacoffee.com/garrit" target="_blank"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&amp;emoji=&amp;slug=garrit&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Cookie&amp;outline_colour=000000&amp;coffee_colour=ffffff"/></a><p class="page__tag-list"><svg class="page__tag-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><a href="/posts?tags=javascript">#<!-- -->javascript</a><a href="/posts?tags=graphql">#<!-- -->graphql</a><a href="/posts?tags=guide">#<!-- -->guide</a><a href="/posts?tags=100DaysToOffload">#<!-- -->100DaysToOffload</a><a href="/posts?tags=programming">#<!-- -->programming</a></p><div class="shareon"><a class="facebook"></a><a class="linkedin"></a><a class="mastodon"></a><a class="pocket"></a><a class="reddit"></a><a class="telegram"></a><a class="twitter"></a><a class="whatsapp"></a></div></div></article></div><footer class="footer"><div class="footer__content"><h3>Links of Interest</h3><a href="/rss.xml">RSS Feed</a><br/><a href="/todo">Todo List</a><br/><a href="https://keyoxide.org/hkp/garrit@slashdev.space">PGP Key</a><br/><a href="/guestbook">Guestbook</a><br/><a href="/blogroll">Blogroll</a><br/><a href="/ctf">Capture the Flag</a><h3>Elsewhere</h3><a href="https://github.com/garritfra" rel="me">Github</a><br/><a href="https://www.linkedin.com/in/garritfranke/">LinkedIn</a><br/><a href="https://fosstodon.org/@garritfra">Mastodon (ActivityPub)</a><br/><a href="/contact">Contact</a></div><p>👻 Proud member of <a target="_blank" href="https://darktheme.club/">darktheme.club</a> <!-- -->👻</p><p>© 2018-<!-- -->2023<!-- --> Garrit Franke<br/><a href="/privacy">Privacy</a> |<!-- --> <a target="_blank" href="https://github.com/garritfra/garrit.xyz">Source Code</a></p></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Server-Side Caching with Apollo GraphQL","date":"2021-10-04","tags":"javascript, graphql, guide, 100DaysToOffload, programming"},"markdownBody":"\nI recently implemented server-side caching for one of our applications at work.\nThis guide tries to document that I've learned. It assumes that you are using\nan apollo server of version 3 or higher.\n\n### What is Server-Side Caching?\n\nThe point of server-side caching is to reduce the load of your database by\n“remembering” the results of a query for a certain period. If the exact same\nquery comes in again, that remembered result will be returned.\n\nCaching should be handled with care. You should never enable caching for your\nentire application. Instead, you should identify the bottlenecks and develop a\nstrategy to overcome them.\n\n### Enabling caching on the server\n\nThe Apollo Team has done a great job\n[documenting](https://www.apollographql.com/docs/apollo-server/performance/caching/)\nthe caching behavior of their server. To add caching to your existing\nApollo-Server, you first have to add the `responseCachePlugin` to your\nconfiguration as shown\n[here](https://www.apollographql.com/docs/apollo-server/performance/caching/#caching-with-responsecacheplugin-advanced):\n\n```js\nimport responseCachePlugin from \"apollo-server-plugin-response-cache\";\n\nconst server = new ApolloServer({\n\t// ...other options...\n\tplugins: [responseCachePlugin()],\n});\n```\n\nThen, you have to configure a cache backend. By default, Apollo Server will\nstore the caches in RAM, but I’d recommend [using\nRedis](https://www.apollographql.com/docs/apollo-server/data/data-sources/#using-memcachedredis-as-a-cache-storage-backend)\n(or Memcached, if you like), especially if your application is spread across\nmultiple instances of the same backend.\n\n```js\nconst { BaseRedisCache } = require(\"apollo-server-cache-redis\");\nconst Redis = require(\"ioredis\");\n\nconst server = new ApolloServer({\n\t// ...\n\tcache: new BaseRedisCache({\n\t\tplugins: [responseCachePlugin()],\n\t\tclient: new Redis({\n\t\t\thost: \"redis-server\",\n\t\t}),\n\t}),\n});\n```\n\n\u003e Note that you have to use the ioredis library here. node_redis is deprecated\n\u003e as of v2.6.0 of apollo-server-cache-redis.\n\nIf everything went well, your server should now know how to cache responses!\nThis alone won’t get you very far, since it doesn’t know what to cache.\n\n### Telling Apollo what to cache\n\nTo make a type cachable, you have to declare **cache hints**. These properties\ncan either be set in the\n[resolver](https://www.apollographql.com/docs/apollo-server/performance/caching/#in-your-resolvers-dynamic),\nor\n[statically](https://www.apollographql.com/docs/apollo-server/performance/caching/#in-your-schema-static)\nin the schema. To keep it simple, this guide will stick to the static method.\nFeel free to experiment with the dynamic approach though!\n\nTo enable cache hints, simply add the following directive to your schema (you\nonly have to do this once):\n\n```gql\nenum CacheControlScope {\n\tPUBLIC\n\tPRIVATE\n}\n\ndirective @cacheControl(\n\tmaxAge: Int\n\tscope: CacheControlScope\n\tinheritMaxAge: Boolean\n) on FIELD_DEFINITION | OBJECT | INTERFACE | UNION\n```\n\nNow you can add the `@cacheControl` directive to every type that should be cached.\n\n```gql\n# This type will be cached for 30 seconds\ntype Post @cacheControl(maxAge: 30) {\n\tid: ID!\n\ttitle: String\n\tauthor: Author\n\tcomments: [Comment]\n}\n```\n\nFor security reasons, these conditions are [very\nstrict](https://www.apollographql.com/docs/apollo-server/performance/caching/#why-are-these-the-maxage-defaults):\n\n\u003e Our philosophy behind Apollo Server caching is that a response should only be\n\u003e considered cacheable if every part of that response opts in to being\n\u003e cacheable.\n\nThis means that every type needs to explicitly decide how long it should be\ncached. According to this note, the example above actually won’t be cached at\nall!\n\nHaving to specify the `maxAge` of every type would be tedious, so the authors\nhave come up with the `inheritMaxAge` property, which allows the type to\ninherit the settings from its parent. So, in order to make our example\ncachable, we have to enable cache control for all its subfields, either by\nsetting the `maxAge` explicitly or by inheriting it from the parent:\n\n```gql\ntype Post @cacheControl(maxAge: 30) {\n\tid: ID!\n\ttitle: String\n\tauthor: Author\n\tcomments: [Comment]\n}\n\ntype Author @cacheControl(inheritMaxAge: true) {\n\tid: ID!\n\tname: String\n}\n\ntype Comment @cacheControl(inheritMaxAge: true) {\n\tid: ID!\n\tbody: String\n}\n```\n\nNow, whenever you query a `Post`, it will be thrown in the cache. If you query\nthe type again within 30 seconds, the query resolver won’t execute. Instead, it\nwill be read from the cache. Keep in mind that cache hints can also be set on\n`query` and `mutation` fields. This can be handy if you want to cache the\nentire response of a request.\n\n### Gotcha 1: Multiple Response Variations\n\nThe use-case where this topic first came up required us to have different\nresponses based on the type of the logged in user. An `Admin` should see a\ndifferent result than a `Visitor`. If you ignore this fact, it could be that a\nvisitor could see the cache result of a query previously executed by an admin!\n\nThis problem can be counteracted by setting extra information in the cache key\nvia `extraCacheKeyData` (see\n[this](https://www.apollographql.com/docs/apollo-server/performance/caching/#configuring-reads-and-writes)\nparagraph):\n\n```js\nplugins: [\n    responseCachePlugin({\n        extraCacheKeyData: (ctx) =\u003e (\n            ctx.context.auth.isAdmin\n        ),\n    }),\n],\n```\n\nThis example can create two distinct caches: One for users that are marked as\nadmins, and one for regular users.\n\n### Gotcha 2: User-specific caches\n\nBesides caching for a group of users, you can also cache responses [for every\nuser\nindividually](https://www.apollographql.com/docs/apollo-server/performance/caching/#identifying-users-for-private-responses).\nYou may have noticed that you can also set a `scope` field in the cache control\ndirective. This will only cache the response if a user is logged in:\n\n```gql\ntype Post {\n\tid: ID!\n\ttitle: String\n\tauthor: Author @cacheControl(maxAge: 10, scope: PRIVATE)\n}\n```\n\nApollo determines if a user is logged in or not, based on if the `sessionId`\nfunction has returned a value other than `null`.\n\n```js\nimport responseCachePlugin from \"apollo-server-plugin-response-cache\";\nconst server = new ApolloServer({\n\t// ...other settings...\n\tplugins: [\n\t\tresponseCachePlugin({\n\t\t\tsessionId: (requestContext) =\u003e\n\t\t\t\trequestContext.request.http.headers.get(\"sessionid\") || null,\n\t\t}),\n\t],\n});\n```\n\nI’m unsure how effective this pattern is, since every user will receive its key\nin the cache. This kind of defeats the purpose of server-side caching, which is\nmeant to reduce load on the database. If you’re trying to cache fields for\nindividual users, you might also want to take a look at client-side caching via\n[apollo-augmented-hooks](https://github.com/appmotion/apollo-augmented-hooks).\n\nThis is post 020 of [#100DaysToOffload](https://100daystooffload.com/).\n"},"__N_SSG":true},"page":"/posts/[post]","query":{"post":"2021-10-04-server-side-caching-with-apollo-graphql"},"buildId":"vpzYAEFlprTw_kfbsfyAn","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>