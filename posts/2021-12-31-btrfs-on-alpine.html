<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>BTRFS on Alpine Linux | Garrit&#x27;s Notes</title><meta name="Description" content="Generalist software developer writing about scalable infrastructure, fullstack development and DevOps practices."/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="manifest" href="/site.webmanifest"/><link rel="webmention" href="https://webmention.io/garrit.xyz/webmention"/><link rel="pingback" href="https://webmention.io/garrit.xyz/xmlrpc"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/f523f3a6124c7e9a.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/f523f3a6124c7e9a.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-5b6b6b4d7d50fc37.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-79c931a4d8897bd8.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/630-04868eb325fdf1e9.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/posts/%5Bpost%5D-acc4cccb9bd6e148.js" defer="" crossorigin=""></script><script src="/_next/static/xTmyJ9yrdHQY-q73T2QuY/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/xTmyJ9yrdHQY-q73T2QuY/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><section class="layout"><header class="header"><nav class="nav" role="navigation" aria-label="main navigation"><div class="header__container"><a href="/" class="header__container__logo">Garrit&#x27;s Notes</a></div><ul class="header__links"><li><a href="/posts">Blog</a></li><li><a href="/contact">Contact</a></li><li><a href="/links">More ...</a></li></ul></nav></header><div class="content"><article class="page h-entry"><div class="page__info"><h1 class="p-name">BTRFS on Alpine Linux</h1><time class="page__info__date">Dec 31 2021</time><p class="tag-list"><a href="/posts?tags=linux">#<!-- -->linux</a><a href="/posts?tags=infrastructure">#<!-- -->infrastructure</a><a href="/posts?tags=note">#<!-- -->note</a><a href="/posts?tags=guide">#<!-- -->guide</a><a href="/posts?tags=100DaysToOffload">#<!-- -->100DaysToOffload</a><a href="/posts?tags=homelab">#<!-- -->homelab</a><a href="/posts?tags=tech">#<!-- -->tech</a></p></div><div class="page__body e-content"><p>I&#x27;m currently in the midst of migrating some of my infrastructure from the cloud
to &quot;on prem&quot;, aka a local server, aka my old PC. I wanted to try alpine linux as
the host OS to see how it behaves as a lightweight server distro.</p>
<p>So far it stands up quite nicely, it has everything you&#x27;d expect from a
linux-based operating system. The only problem I encountered was getting BTRFS
to work out of the box. Here are some things you should know when using BTRFS on
Alpine linux.</p>
<h3 id="installing-btrfs">Installing BTRFS</h3>
<p>Installing BTRFS is relatively straight forward. Simply install the package and
tell Alpine to load the module on startup:</p>
<pre><code>apk add btrfs-progs
echo btrfs &gt;&gt; /etc/modules
</code></pre>
<p>To load the module right away, you can use the following command:</p>
<pre><code>modprobe btrfs
</code></pre>
<h3 id="mounting-a-volume">Mounting a volume</h3>
<p>If you try mounting a btrfs volume via your fstab, you will get an error. This
is because BTRFS does not know about the drives yet when the filesystems are
mounted. To work around this, you can create an OpenRC service that runs a
<code>btrfs scan</code> to detect the drives. To do so, create a service under
<code>/etc/init.d/btrfs-scan</code> with the following content:</p>
<pre><code class="language-sh">#!/sbin/openrc-run

name=&quot;btrfs-scan&quot;

depend() {
  before localmount
}

start() {
  /sbin/btrfs device scan
}
</code></pre>
<p>Make the service executable and register it:</p>
<pre><code>chmod +x /etc/init.d/btrfs-scan
rc-update add btrfs-scan boot
</code></pre>
<p>Now, you should be able to add the volume to your <code>/etc/fstab</code>:</p>
<pre><code>UUID=abcdef-0055-4958-990f-1413ed1186ec  /var/data  btrfs   defaults,nofail,subvol=@  0  0
</code></pre>
<p>After a reboot, you should be able to see the drive mounted at <code>/var/data</code>.</p>
<h3 id="resources">Resources</h3>
<ul>
<li><a href="https://nparsons.uk/blog/using-btrfs-on-alpine-linux">Nathan Parsons - &quot;Using BTRFS on Alpine Linux&quot;</a></li>
<li><a href="https://gitlab-test.alpinelinux.org/alpine/aports/-/issues/9539">A bug report about this problem</a></li>
</ul>
<p>This is post 023 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p><p class="horizontal-list"><button>üíåÔ∏è Reply via E-Mail</button><button>üîó Share</button><button>‚úèÔ∏è Fix Typo</button></p><hr/><h2>Continue Reading</h2><div><div class="blog__list__post"><time class="blog__list__post__date">Jan 18 2024</time><br/><a href="/posts/2024-01-18-cost-per-request">Cost per Request</a></div><div class="blog__list__post"><time class="blog__list__post__date">Jan 06 2024</time><br/><a href="/posts/2024-01-06-a-better-publishing-workflow-for-static-blogs">A better publishing workflow for static blogs</a></div><div class="blog__list__post"><time class="blog__list__post__date">Jan 05 2024</time><br/><a href="/posts/2024-01-05-greg-the-developer">Greg, the Developer</a></div><div class="blog__list__post"><time class="blog__list__post__date">Dec 28 2023</time><br/><a href="/posts/2023-12-28-linkdump-2">Linkdump #2</a></div><div class="blog__list__post"><time class="blog__list__post__date">Dec 22 2023</time><br/><a href="/posts/2023-12-22-10-000-hours">10.000 Hours</a></div></div></div></article></div><footer class="footer"><div class="footer__content"><h3>Links of Interest</h3><a href="/rss.xml">RSS Feed</a><br/><a href="/todo">Todo List</a><br/><a href="https://keys.openpgp.org/vks/v1/by-fingerprint/2218337E54AA1DBE207B404DBB54AF7EB0939F3D">PGP Key</a><br/><a href="/guestbook">Guestbook</a><br/><a href="/blogroll">Blogroll</a><br/><a href="/ctf">Capture the Flag</a><h3>Elsewhere</h3><a href="https://github.com/garritfra" rel="me">Github</a><br/><a href="https://www.linkedin.com/in/garritfranke/">LinkedIn</a><br/><a href="https://fosstodon.org/@garritfra">Mastodon (ActivityPub)</a><br/><a href="/contact">Contact</a></div><a href="https://www.buymeacoffee.com/garrit" target="_blank"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a tea&amp;emoji=&amp;slug=garrit&amp;button_colour=FFB300&amp;font_colour=000000&amp;font_family=Cookie&amp;outline_colour=000000&amp;coffee_colour=ffffff"/></a><p>üëª Proud member of <a target="_blank" href="https://darktheme.club/">darktheme.club</a> <!-- -->üëª</p><p>¬© 2018-<!-- -->2024<!-- --> Garrit Franke<br/><a href="/privacy">Privacy</a> |<!-- --> <a target="_blank" href="https://github.com/garritfra/garrit.xyz">Source Code</a></p></footer></section></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"post":{"slug":"2021-12-31-btrfs-on-alpine","markdownBody":"\nI'm currently in the midst of migrating some of my infrastructure from the cloud\nto \"on prem\", aka a local server, aka my old PC. I wanted to try alpine linux as\nthe host OS to see how it behaves as a lightweight server distro.\n\nSo far it stands up quite nicely, it has everything you'd expect from a\nlinux-based operating system. The only problem I encountered was getting BTRFS\nto work out of the box. Here are some things you should know when using BTRFS on\nAlpine linux.\n\n### Installing BTRFS\n\nInstalling BTRFS is relatively straight forward. Simply install the package and\ntell Alpine to load the module on startup:\n\n```\napk add btrfs-progs\necho btrfs \u003e\u003e /etc/modules\n```\n\nTo load the module right away, you can use the following command:\n\n```\nmodprobe btrfs\n```\n\n### Mounting a volume\n\nIf you try mounting a btrfs volume via your fstab, you will get an error. This\nis because BTRFS does not know about the drives yet when the filesystems are\nmounted. To work around this, you can create an OpenRC service that runs a\n`btrfs scan` to detect the drives. To do so, create a service under\n`/etc/init.d/btrfs-scan` with the following content:\n\n```sh\n#!/sbin/openrc-run\n\nname=\"btrfs-scan\"\n\ndepend() {\n  before localmount\n}\n\nstart() {\n  /sbin/btrfs device scan\n}\n```\n\nMake the service executable and register it:\n\n```\nchmod +x /etc/init.d/btrfs-scan\nrc-update add btrfs-scan boot\n```\n\nNow, you should be able to add the volume to your `/etc/fstab`:\n\n```\nUUID=abcdef-0055-4958-990f-1413ed1186ec  /var/data  btrfs   defaults,nofail,subvol=@  0  0\n```\n\nAfter a reboot, you should be able to see the drive mounted at `/var/data`.\n\n### Resources\n\n- [Nathan Parsons - \"Using BTRFS on Alpine Linux\"](https://nparsons.uk/blog/using-btrfs-on-alpine-linux)\n- [A bug report about this problem](https://gitlab-test.alpinelinux.org/alpine/aports/-/issues/9539)\n\nThis is post 023 of [#100DaysToOffload](https://100daystooffload.com/).\n","frontmatter":{"title":"BTRFS on Alpine Linux","date":"2021-12-31","tags":"linux, infrastructure, note, guide, 100DaysToOffload, homelab, tech"},"tags":["linux","infrastructure","note","guide","100DaysToOffload","homelab","tech"]},"recommendedPosts":[{"slug":"2024-01-18-cost-per-request","frontmatter":{"title":"Cost per Request","date":"2024-01-18","tags":"infrastructure, aws, note, opinion, devops, tech"},"tags":["infrastructure","aws","note","opinion","devops","tech"]},{"slug":"2024-01-06-a-better-publishing-workflow-for-static-blogs","frontmatter":{"title":"A better publishing workflow for static blogs","date":"2024-01-06","tags":"guide, note, meta, writing, web, github, tech"},"tags":["guide","note","meta","writing","web","github","tech"]},{"slug":"2024-01-05-greg-the-developer","frontmatter":{"title":"Greg, the Developer","date":"2024-01-05","tags":"note, tech, fun, shortstory, writing, programming, practices, devops"},"tags":["note","tech","fun","shortstory","writing","programming","practices","devops"]},{"slug":"2023-12-28-linkdump-2","frontmatter":{"title":"Linkdump #2","date":"2023-12-28","tags":"note, tech, programming, linkdump"},"tags":["note","tech","programming","linkdump"]},{"slug":"2023-12-22-10-000-hours","frontmatter":{"title":"10.000 Hours","date":"2023-12-22","tags":"100DaysToOffload, note, learnings, books, tech, programming"},"tags":["100DaysToOffload","note","learnings","books","tech","programming"]}]},"__N_SSG":true},"page":"/posts/[post]","query":{"post":"2021-12-31-btrfs-on-alpine"},"buildId":"xTmyJ9yrdHQY-q73T2QuY","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>