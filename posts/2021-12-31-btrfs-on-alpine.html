<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>BTRFS on Alpine Linux | Garrit&#x27;s Notes</title><meta name="Description" content="Generalist developer writing about fullstack development, system administration and free software."/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="webmention" href="https://webmention.io/garrit.xyz/webmention"/><link rel="pingback" href="https://webmention.io/garrit.xyz/xmlrpc"/><link href="https://cdn.jsdelivr.net/npm/shareon@2/dist/shareon.min.css" rel="stylesheet"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/68c1774d6f13d2c6.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/68c1774d6f13d2c6.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-fa99431b15635937.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-0c7baedefba6b077.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-c379b48138cf9870.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-af9059f49c929f91.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/996-f63e9faf058fa8be.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/906-4c1fdb46731272c4.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/posts/%5Bpost%5D-720e63f816db2a3d.js" defer="" crossorigin=""></script><script src="/_next/static/tRMKV3ulTthlehQTTtzg2/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/tRMKV3ulTthlehQTTtzg2/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><section class="layout"><header class="header"><nav class="nav" role="navigation" aria-label="main navigation"><div class="header__container"><a href="/" class="header__container__logo underlined">Garrit&#x27;s Notes</a></div><ul class="header__links"><li><a href="/posts" class="underlined">Blog</a></li><li><a href="/contact" class="underlined">Contact</a></li><li><a href="/links" class="underlined">More ...</a></li></ul></nav></header><div class="content"><article class="page h-entry"><div class="page__info"><h1 class="p-name">BTRFS on Alpine Linux</h1><time class="page__info__date">Dec 31 2021</time><p class="tag-list"><a href="/posts?tags=linux">#<!-- -->linux</a><a href="/posts?tags=infrastructure">#<!-- -->infrastructure</a><a href="/posts?tags=note">#<!-- -->note</a><a href="/posts?tags=guide">#<!-- -->guide</a><a href="/posts?tags=100DaysToOffload">#<!-- -->100DaysToOffload</a><a href="/posts?tags=homelab">#<!-- -->homelab</a></p></div><div class="page__body e-content"><p>I&#x27;m currently in the midst of migrating some of my infrastructure from the cloud
to &quot;on prem&quot;, aka a local server, aka my old PC. I wanted to try alpine linux as
the host OS to see how it behaves as a lightweight server distro.</p>
<p>So far it stands up quite nicely, it has everything you&#x27;d expect from a
linux-based operating system. The only problem I encountered was getting BTRFS
to work out of the box. Here are some things you should know when using BTRFS on
Alpine linux.</p>
<h3 id="installing-btrfs">Installing BTRFS</h3>
<p>Installing BTRFS is relatively straight forward. Simply install the package and
tell Alpine to load the module on startup:</p>
<pre><code>apk add btrfs-progs
echo btrfs &gt;&gt; /etc/modules
</code></pre>
<p>To load the module right away, you can use the following command:</p>
<pre><code>modprobe btrfs
</code></pre>
<h3 id="mounting-a-volume">Mounting a volume</h3>
<p>If you try mounting a btrfs volume via your fstab, you will get an error. This
is because BTRFS does not know about the drives yet when the filesystems are
mounted. To work around this, you can create an OpenRC service that runs a
<code>btrfs scan</code> to detect the drives. To do so, create a service under
<code>/etc/init.d/btrfs-scan</code> with the following content:</p>
<pre><code class="language-sh">#!/sbin/openrc-run

name=&quot;btrfs-scan&quot;

depend() {
  before localmount
}

start() {
  /sbin/btrfs device scan
}
</code></pre>
<p>Make the service executable and register it:</p>
<pre><code>chmod +x /etc/init.d/btrfs-scan
rc-update add btrfs-scan boot
</code></pre>
<p>Now, you should be able to add the volume to your <code>/etc/fstab</code>:</p>
<pre><code>UUID=abcdef-0055-4958-990f-1413ed1186ec  /var/data  btrfs   defaults,nofail,subvol=@  0  0
</code></pre>
<p>After a reboot, you should be able to see the drive mounted at <code>/var/data</code>.</p>
<h3 id="resources">Resources</h3>
<ul>
<li><a href="https://nparsons.uk/blog/using-btrfs-on-alpine-linux">Nathan Parsons - &quot;Using BTRFS on Alpine Linux&quot;</a></li>
<li><a href="https://gitlab-test.alpinelinux.org/alpine/aports/-/issues/9539">A bug report about this problem</a></li>
</ul>
<p>This is post 023 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p><hr/><p><a href="mailto:garrit@slashdev.space?subject=Re: BTRFS%20on%20Alpine%20Linux">Reply via E-Mail</a></p><a href="https://www.buymeacoffee.com/garrit" target="_blank"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&amp;emoji=&amp;slug=garrit&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Cookie&amp;outline_colour=000000&amp;coffee_colour=ffffff"/></a><div class="shareon"><a class="facebook"></a><a class="linkedin"></a><a class="mastodon"></a><a class="pocket"></a><a class="reddit"></a><a class="telegram"></a><a class="twitter"></a><a class="whatsapp"></a></div><hr/><h2>Continue Reading</h2><div><div class="blog__list__post"><time class="blog__list__post__date">Nov 01 2023</time><br/><a href="/posts/2023-11-01-tracking-sqlite-database-changes-in-git">Tracking SQLite Database Changes in Git</a></div><div class="blog__list__post"><time class="blog__list__post__date">Oct 13 2023</time><br/><a href="/posts/2023-10-13-organizing-multiple-git-identities">Organizing multiple Git identities</a></div><div class="blog__list__post"><time class="blog__list__post__date">Jun 01 2023</time><br/><a href="/posts/2023-06-01-single-page-applications-on-github-pages">Single Page Applications on GitHub Pages</a></div><div class="blog__list__post"><time class="blog__list__post__date">Apr 28 2023</time><br/><a href="/posts/2023-04-28-serverless-framework-retrospective">Serverless Framework Retrospective</a></div><div class="blog__list__post"><time class="blog__list__post__date">Apr 27 2023</time><br/><a href="/posts/2023-04-27-migrating-homeassistant-from-sd-to-ssd">Migrating Homeassistant from SD to SSD</a></div></div></div></article></div><footer class="footer"><div class="footer__content"><h3>Links of Interest</h3><a href="/rss.xml">RSS Feed</a><br/><a href="/todo">Todo List</a><br/><a href="https://keyoxide.org/hkp/garrit@slashdev.space">PGP Key</a><br/><a href="/guestbook">Guestbook</a><br/><a href="/blogroll">Blogroll</a><br/><a href="/ctf">Capture the Flag</a><h3>Elsewhere</h3><a href="https://github.com/garritfra" rel="me">Github</a><br/><a href="https://www.linkedin.com/in/garritfranke/">LinkedIn</a><br/><a href="https://fosstodon.org/@garritfra">Mastodon (ActivityPub)</a><br/><a href="/contact">Contact</a></div><p>ðŸ‘»Â Proud member of <a target="_blank" href="https://darktheme.club/">darktheme.club</a> <!-- -->ðŸ‘»</p><p>Â© 2018-<!-- -->2023<!-- --> Garrit Franke<br/><a href="/privacy">Privacy</a> |<!-- --> <a target="_blank" href="https://github.com/garritfra/garrit.xyz">Source Code</a></p></footer></section></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"post":{"slug":"2021-12-31-btrfs-on-alpine","markdownBody":"\nI'm currently in the midst of migrating some of my infrastructure from the cloud\nto \"on prem\", aka a local server, aka my old PC. I wanted to try alpine linux as\nthe host OS to see how it behaves as a lightweight server distro.\n\nSo far it stands up quite nicely, it has everything you'd expect from a\nlinux-based operating system. The only problem I encountered was getting BTRFS\nto work out of the box. Here are some things you should know when using BTRFS on\nAlpine linux.\n\n### Installing BTRFS\n\nInstalling BTRFS is relatively straight forward. Simply install the package and\ntell Alpine to load the module on startup:\n\n```\napk add btrfs-progs\necho btrfs \u003e\u003e /etc/modules\n```\n\nTo load the module right away, you can use the following command:\n\n```\nmodprobe btrfs\n```\n\n### Mounting a volume\n\nIf you try mounting a btrfs volume via your fstab, you will get an error. This\nis because BTRFS does not know about the drives yet when the filesystems are\nmounted. To work around this, you can create an OpenRC service that runs a\n`btrfs scan` to detect the drives. To do so, create a service under\n`/etc/init.d/btrfs-scan` with the following content:\n\n```sh\n#!/sbin/openrc-run\n\nname=\"btrfs-scan\"\n\ndepend() {\n  before localmount\n}\n\nstart() {\n  /sbin/btrfs device scan\n}\n```\n\nMake the service executable and register it:\n\n```\nchmod +x /etc/init.d/btrfs-scan\nrc-update add btrfs-scan boot\n```\n\nNow, you should be able to add the volume to your `/etc/fstab`:\n\n```\nUUID=abcdef-0055-4958-990f-1413ed1186ec  /var/data  btrfs   defaults,nofail,subvol=@  0  0\n```\n\nAfter a reboot, you should be able to see the drive mounted at `/var/data`.\n\n### Resources\n\n- [Nathan Parsons - \"Using BTRFS on Alpine Linux\"](https://nparsons.uk/blog/using-btrfs-on-alpine-linux)\n- [A bug report about this problem](https://gitlab-test.alpinelinux.org/alpine/aports/-/issues/9539)\n\nThis is post 023 of [#100DaysToOffload](https://100daystooffload.com/).\n","frontmatter":{"title":"BTRFS on Alpine Linux","date":"2021-12-31","tags":"linux, infrastructure, note, guide, 100DaysToOffload, homelab"},"tags":["linux","infrastructure","note","guide","100DaysToOffload","homelab"]},"recommendedPosts":[{"slug":"2023-11-01-tracking-sqlite-database-changes-in-git","frontmatter":{"title":"Tracking SQLite Database Changes in Git","date":"2023-11-01","tags":"100DaysToOffload, guide, note, til, git, tech, sqlite"},"tags":["100DaysToOffload","guide","note","til","git","tech","sqlite"]},{"slug":"2023-10-13-organizing-multiple-git-identities","frontmatter":{"title":"Organizing multiple Git identities","date":"2023-10-13","tags":"100DaysToOffload, guide, note, til, git, tech"},"tags":["100DaysToOffload","guide","note","til","git","tech"]},{"slug":"2023-06-01-single-page-applications-on-github-pages","frontmatter":{"title":"Single Page Applications on GitHub Pages","date":"2023-06-01","tags":"100DaysToOffload, guide, note, web, javascript, github"},"tags":["100DaysToOffload","guide","note","web","javascript","github"]},{"slug":"2023-04-28-serverless-framework-retrospective","frontmatter":{"title":"Serverless Framework Retrospective","date":"2023-04-28","tags":"100DaysToOffload, infrastructure, aws, note, terraform, learnings, devops, serverless"},"tags":["100DaysToOffload","infrastructure","aws","note","terraform","learnings","devops","serverless"]},{"slug":"2023-04-27-migrating-homeassistant-from-sd-to-ssd","frontmatter":{"title":"Migrating Homeassistant from SD to SSD","date":"2023-04-27","tags":"100DaysToOffload, guide, note, homeassistant, homelab"},"tags":["100DaysToOffload","guide","note","homeassistant","homelab"]}]},"__N_SSG":true},"page":"/posts/[post]","query":{"post":"2021-12-31-btrfs-on-alpine"},"buildId":"tRMKV3ulTthlehQTTtzg2","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>