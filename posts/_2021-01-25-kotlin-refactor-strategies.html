<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>Garrit&#x27;s Notes</title><meta name="Description" content="Generalist developer writing about fullstack development, system administration and free software."/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="webmention" href="https://webmention.io/garrit.xyz/webmention"/><link rel="pingback" href="https://webmention.io/garrit.xyz/xmlrpc"/><meta name="next-head-count" content="7"/><link rel="preload" href="https://garrit.xyz/_next/static/css/b244449f4a82ed37.css" as="style"/><link rel="stylesheet" href="https://garrit.xyz/_next/static/css/b244449f4a82ed37.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="https://garrit.xyz/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="https://garrit.xyz/_next/static/chunks/webpack-419417af898ef431.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/main-c586b89e07064d4a.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/pages/_app-893697fd17d143b4.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/143-791653d4a18da625.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/746-6cb8fd2335c400fd.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/768-d1db3457a00e9fa7.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/pages/posts/%5Bpost%5D-231c4aad90c080f3.js" defer=""></script><script src="https://garrit.xyz/_next/static/KG1cA7uc0gJPx-jDIkQuc/_buildManifest.js" defer=""></script><script src="https://garrit.xyz/_next/static/KG1cA7uc0gJPx-jDIkQuc/_ssgManifest.js" defer=""></script><script src="https://garrit.xyz/_next/static/KG1cA7uc0gJPx-jDIkQuc/_middlewareManifest.js" defer=""></script><style id="__jsx-8946a52cf42f2313">.layout.jsx-8946a52cf42f2313{overflow-x:hidden;
display:-webkit-box;
display:-webkit-flex;
display:-ms-flexbox;
display:flex;
-webkit-flex-direction:column;
-ms-flex-direction:column;
flex-direction:column;
min-height:100vh}
.layout.jsx-8946a52cf42f2313 .info_page.jsx-8946a52cf42f2313{color:#ebebeb}
.content.jsx-8946a52cf42f2313{}
@media (min-width:768px) {}</style></head><body><div id="__next" data-reactroot=""><section class="jsx-8946a52cf42f2313 layout"><header class="header"><a href="https://donate.redcrossredcrescent.org/ua/donate/~my-donation?_cv=1" style="height:64px;text-align:center" class="flag--ukraine" target="_blank">Help Ukraine</a><nav class="nav" role="navigation" aria-label="main navigation"><div class="header__container"><a href="/" class="header__container__logo underlined">Garrit&#x27;s Notes</a></div><ul class="header__links"><li><a href="/posts" class="underlined">Blog</a></li><li><a href="/contact" class="underlined">Contact</a></li><li><a href="/cv" class="underlined">Resume</a></li></ul></nav></header><div class="jsx-8946a52cf42f2313 content"><article class="page h-entry"><div class="page__info"><h1 class="p-name">Fixing nullability issues when migrating to Kotlin</h1><h3 class="page__info__date">Jan 23 2021</h3></div><div class="page__body e-content"><p>The last couple of days, I had the opportunity to refactor some of the Kotlin code in our massive android project. The app is quite old, and a lot of legacy code has accumulated over the years. At one point, we decided to migrate a lot of our view-logic from Java to Kotlin. Instead of cleaning the code up, this lead to an even bigger buildup of technical debt. The problem was that we mainly used the migration-tools that Android Studio provides, which, at that time where not very sophisticated. Sometimes we had to manually fix some things which, since it is such a massive codebase, we didn&#x27;t really take the time to clean every converted file up.</p>
<p>Once the number of warnings approached infinity, we finally decided to dedicate a chunk of each sprint to house-cleaning in our codebase. My recent refactoring involved cleaning up unsafe usages, and I want to share some of my approaches to this kind of refactoring.</p>
<h2 id="obvious-fixes" level="2">Obvious fixes</h2>
<p>I encountered this kind of pattern a number of times during my refactoring:</p>
<pre><code class="language-kt">textView!!.setOnClickListener { showDialog() }
</code></pre>
<p>If you see something like this, your alarm bells should immediately ring. If textView is <code>null</code>, the app would crash. The same behavior is happening with java, so a switch from Java to kotlin would be pointless.</p>
<p>The simple fix is to replace the <code>!!</code> operator with a <code>?</code>, which only executes the line of code if the element is not null.</p>
<pre><code class="language-kt">textView?.setOnClickListener { showDialog() }
</code></pre>
<p>Of course, if the view <em>is</em> null even though you&#x27;re expecting a value, you should probably do something about this. A simple way to handle this is to add some &quot;sanity checks&quot; to your code. Create an <code>assert</code> function that throws an <code>AssertionError</code> if a given condition is false. Unfortunately, android does not use the builtin <code>assert</code> function that kotlin provides, so you will have to write your own. The neat thing about <code>assert</code> is that you can toggle this behavior, meaning you can enable assertion errors in the debug build, but disable it in the final production build to prevent the app from randomly crashing.</p>
<pre><code class="language-kt">assert(textView != null)
textView?.setOnClickListener { showDialog() }
</code></pre>
<h2 id="more-complex-cases" level="2">More complex cases</h2>
<p>Let&#x27;s take a look at this code: ...</p>
<p>This is post 007 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p><hr/><a href="mailto:garrit@slashdev.space?subject=Re: Fixing%20nullability%20issues%20when%20migrating%20to%20Kotlin">Reply via E-Mail</a></div><div class="page__footer"></div></article></div><footer class="footer"><div class="footer__content"><section class="footer__content__links"><h3>Links of Interest</h3><a href="/rss.xml">RSS Feed</a><br/><a href="/todo">Todo List</a><br/><a href="https://keyoxide.org/hkp/garrit@slashdev.space">PGP Key</a><br/><a href="/blogroll">Blogroll</a></section><section class="footer__content__social"><h3>Elsewhere</h3><a href="https://github.com/garritfra" rel="me">Github</a><br/><a href="https://www.linkedin.com/in/garritfranke/">LinkedIn</a><br/><a href="https://fosstodon.org/@garritfra">Mastodon (ActivityPub)</a><br/><a href="/contact">Contact</a></section></div><p>Â© 2018-2022 Garrit Franke</p></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Fixing nullability issues when migrating to Kotlin","date":"2021-01-23"},"markdownBody":"\nThe last couple of days, I had the opportunity to refactor some of the Kotlin code in our massive android project. The app is quite old, and a lot of legacy code has accumulated over the years. At one point, we decided to migrate a lot of our view-logic from Java to Kotlin. Instead of cleaning the code up, this lead to an even bigger buildup of technical debt. The problem was that we mainly used the migration-tools that Android Studio provides, which, at that time where not very sophisticated. Sometimes we had to manually fix some things which, since it is such a massive codebase, we didn't really take the time to clean every converted file up.\n\nOnce the number of warnings approached infinity, we finally decided to dedicate a chunk of each sprint to house-cleaning in our codebase. My recent refactoring involved cleaning up unsafe usages, and I want to share some of my approaches to this kind of refactoring.\n\n## Obvious fixes\n\nI encountered this kind of pattern a number of times during my refactoring:\n\n```kt\ntextView!!.setOnClickListener { showDialog() }\n```\n\nIf you see something like this, your alarm bells should immediately ring. If textView is `null`, the app would crash. The same behavior is happening with java, so a switch from Java to kotlin would be pointless.\n\nThe simple fix is to replace the `!!` operator with a `?`, which only executes the line of code if the element is not null.\n\n```kt\ntextView?.setOnClickListener { showDialog() }\n```\n\nOf course, if the view _is_ null even though you're expecting a value, you should probably do something about this. A simple way to handle this is to add some \"sanity checks\" to your code. Create an `assert` function that throws an `AssertionError` if a given condition is false. Unfortunately, android does not use the builtin `assert` function that kotlin provides, so you will have to write your own. The neat thing about `assert` is that you can toggle this behavior, meaning you can enable assertion errors in the debug build, but disable it in the final production build to prevent the app from randomly crashing.\n\n```kt\nassert(textView != null)\ntextView?.setOnClickListener { showDialog() }\n```\n\n## More complex cases\n\nLet's take a look at this code: ...\n\nThis is post 007 of [#100DaysToOffload](https://100daystooffload.com/).\n"},"__N_SSG":true},"page":"/posts/[post]","query":{"post":"_2021-01-25-kotlin-refactor-strategies"},"buildId":"KG1cA7uc0gJPx-jDIkQuc","assetPrefix":"https://garrit.xyz","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>