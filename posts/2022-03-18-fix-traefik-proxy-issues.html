<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>Fixing Traefik Proxy Issues | Garrit&#x27;s Notes</title><meta name="Description" content="Generalist software developer writing about scalable infrastructure, fullstack development and DevOps practices."/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="manifest" href="/site.webmanifest"/><link rel="webmention" href="https://webmention.io/garrit.xyz/webmention"/><link rel="pingback" href="https://webmention.io/garrit.xyz/xmlrpc"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/f523f3a6124c7e9a.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/f523f3a6124c7e9a.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-d2ba44903cd47711.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-79c931a4d8897bd8.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/630-04868eb325fdf1e9.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/posts/%5Bpost%5D-acc4cccb9bd6e148.js" defer="" crossorigin=""></script><script src="/_next/static/3DsOoiq6ySl39UExIPsH3/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/3DsOoiq6ySl39UExIPsH3/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><section class="layout"><header class="header"><nav class="nav" role="navigation" aria-label="main navigation"><div class="header__container"><a href="/" class="header__container__logo">Garrit&#x27;s Notes</a></div><ul class="header__links"><li><a href="/posts">Blog</a></li><li><a href="/contact">Contact</a></li><li><a href="/links">More ...</a></li></ul></nav></header><div class="content"><article class="page h-entry"><div class="page__info"><h1 class="p-name">Fixing Traefik Proxy Issues</h1><time class="page__info__date">Mar 18 2022</time><p class="tag-list"><a href="/posts?tags=note">#<!-- -->note</a><a href="/posts?tags=guide">#<!-- -->guide</a><a href="/posts?tags=infrastructure">#<!-- -->infrastructure</a><a href="/posts?tags=web">#<!-- -->web</a><a href="/posts?tags=100DaysToOffload">#<!-- -->100DaysToOffload</a><a href="/posts?tags=homelab">#<!-- -->homelab</a><a href="/posts?tags=tech">#<!-- -->tech</a></p></div><div class="page__body e-content"><p>After changing my proxy from NGINX to Traefik, I noticed that some of my
services started misbehaving.</p>
<p>In particular, my instance of
<a href="https://github.com/NicolasConstant/BirdsiteLive">BirdsiteLive</a>
(<a href="https://birdsite.slashdev.space">birdsite.slashdev.space</a>) had issues
forwarding tweets to the
<a href="https://garrit.xyz/posts/2021-01-18-reasons-the-fediverse-is-better">Fediverse</a>.</p>
<p>The only difference between my old NGINX and my Traefik config were the headers.
I didn&#x27;t think that that&#x27;s what&#x27;s causing the issue, but after digging around a
bit I figured out what&#x27;s wrong. I still can&#x27;t wrap my head around it entirely,
but it has something to do with forwarding external <code>https</code> requests to internal
<code>http</code> services, since the <code>x-forwarded-</code> headers where missing in the forwarded
requests.</p>
<p>In the world of NGINX, we can instruct the proxy to forward <em>all</em> headers using
this directive:</p>
<pre><code class="language-conf">proxy_pass_request_headers      on;
</code></pre>
<p>which takes care of the issue. In Traefik, it&#x27;s a bit more convoluted. Traefik
can use a combination of &quot;Entrypoints&quot; and middleware to route traffic around.
In my setup, I use a <code>webSecure</code> entrypoint listening for SSL/TLS traffic, and a
<code>web</code> entrypoint that just redirects to <code>webSecure</code>:</p>
<pre><code class="language-yaml">entryPoints:
  web:
    address: :80
    http:
      redirections:
        entryPoint:
          to: &quot;websecure&quot;
          scheme: &quot;https&quot;

  websecure:
    address: :443
</code></pre>
<p>Apparently, some services send requests to the <code>web</code> entrypoint, and the
<code>x-forwarded-for</code> headers are dropped. To prevent this, you can set the
<code>proxyProtocol</code> and <code>forwardedHeaders</code> in the <code>web</code> entrypoint to <code>insecure</code>,
like so:</p>
<pre><code class="language-yaml">entryPoints:
  web:
    address: :80
    proxyProtocol:
      insecure: true
    forwardedHeaders:
      insecure: true
    # ...
# ...
</code></pre>
<p>I&#x27;m sure there&#x27;s a reason why this is marked as <code>insecure</code>, but it behaves just
like the NGINX counterpart, so I didn&#x27;t bother digging deeper into the matter.
Maybe one day I&#x27;ll come back to properly fix this.</p>
<p>If you want to read more, check out
<a href="https://medium.com/@_jonas/traefik-kubernetes-ingress-and-x-forwarded-headers-82194d319b0e">this</a>
article on Medium. It explains the issue in more detail.</p>
<hr/>
<p>This is post 025 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p><p class="horizontal-list"><button>üíåÔ∏è Reply via E-Mail</button><button>üîó Share</button><button>‚úèÔ∏è Fix Typo</button></p><hr/><h2>Continue Reading</h2><div><div class="blog__list__post"><time class="blog__list__post__date">Jan 18 2024</time><br/><a href="/posts/2024-01-18-cost-per-request">Cost per Request</a></div><div class="blog__list__post"><time class="blog__list__post__date">Jan 06 2024</time><br/><a href="/posts/2024-01-06-a-better-publishing-workflow-for-static-blogs">A better publishing workflow for static blogs</a></div><div class="blog__list__post"><time class="blog__list__post__date">Jan 05 2024</time><br/><a href="/posts/2024-01-05-greg-the-developer">Greg, the Developer</a></div><div class="blog__list__post"><time class="blog__list__post__date">Dec 28 2023</time><br/><a href="/posts/2023-12-28-linkdump-2">Linkdump #2</a></div><div class="blog__list__post"><time class="blog__list__post__date">Dec 22 2023</time><br/><a href="/posts/2023-12-22-10-000-hours">10.000 Hours</a></div></div></div></article></div><footer class="footer"><div class="footer__content"><h3>Links of Interest</h3><a href="/rss.xml">RSS Feed</a><br/><a href="/todo">Todo List</a><br/><a href="https://keys.openpgp.org/vks/v1/by-fingerprint/2218337E54AA1DBE207B404DBB54AF7EB0939F3D">PGP Key</a><br/><a href="/guestbook">Guestbook</a><br/><a href="/blogroll">Blogroll</a><br/><a href="/ctf">Capture the Flag</a><h3>Elsewhere</h3><a href="https://github.com/garritfra" rel="me">Github</a><br/><a href="https://www.linkedin.com/in/garritfranke/">LinkedIn</a><br/><a href="https://fosstodon.org/@garritfra">Mastodon (ActivityPub)</a><br/><a href="/contact">Contact</a></div><a href="https://www.buymeacoffee.com/garrit" target="_blank"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a tea&amp;emoji=&amp;slug=garrit&amp;button_colour=FFB300&amp;font_colour=000000&amp;font_family=Cookie&amp;outline_colour=000000&amp;coffee_colour=ffffff"/></a><p>üëª Proud member of <a target="_blank" href="https://darktheme.club/">darktheme.club</a> <!-- -->üëª</p><p>¬© 2018-<!-- -->2024<!-- --> Garrit Franke<br/><a href="/privacy">Privacy</a> |<!-- --> <a target="_blank" href="https://github.com/garritfra/garrit.xyz">Source Code</a></p></footer></section></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"post":{"slug":"2022-03-18-fix-traefik-proxy-issues","markdownBody":"\nAfter changing my proxy from NGINX to Traefik, I noticed that some of my\nservices started misbehaving.\n\nIn particular, my instance of\n[BirdsiteLive](https://github.com/NicolasConstant/BirdsiteLive)\n([birdsite.slashdev.space](https://birdsite.slashdev.space)) had issues\nforwarding tweets to the\n[Fediverse](https://garrit.xyz/posts/2021-01-18-reasons-the-fediverse-is-better).\n\nThe only difference between my old NGINX and my Traefik config were the headers.\nI didn't think that that's what's causing the issue, but after digging around a\nbit I figured out what's wrong. I still can't wrap my head around it entirely,\nbut it has something to do with forwarding external `https` requests to internal\n`http` services, since the `x-forwarded-` headers where missing in the forwarded\nrequests.\n\nIn the world of NGINX, we can instruct the proxy to forward _all_ headers using\nthis directive:\n\n```conf\nproxy_pass_request_headers      on;\n```\n\nwhich takes care of the issue. In Traefik, it's a bit more convoluted. Traefik\ncan use a combination of \"Entrypoints\" and middleware to route traffic around.\nIn my setup, I use a `webSecure` entrypoint listening for SSL/TLS traffic, and a\n`web` entrypoint that just redirects to `webSecure`:\n\n```yaml\nentryPoints:\n  web:\n    address: :80\n    http:\n      redirections:\n        entryPoint:\n          to: \"websecure\"\n          scheme: \"https\"\n\n  websecure:\n    address: :443\n```\n\nApparently, some services send requests to the `web` entrypoint, and the\n`x-forwarded-for` headers are dropped. To prevent this, you can set the\n`proxyProtocol` and `forwardedHeaders` in the `web` entrypoint to `insecure`,\nlike so:\n\n```yaml\nentryPoints:\n  web:\n    address: :80\n    proxyProtocol:\n      insecure: true\n    forwardedHeaders:\n      insecure: true\n    # ...\n# ...\n```\n\nI'm sure there's a reason why this is marked as `insecure`, but it behaves just\nlike the NGINX counterpart, so I didn't bother digging deeper into the matter.\nMaybe one day I'll come back to properly fix this.\n\nIf you want to read more, check out\n[this](https://medium.com/@_jonas/traefik-kubernetes-ingress-and-x-forwarded-headers-82194d319b0e)\narticle on Medium. It explains the issue in more detail.\n\n---\n\nThis is post 025 of [#100DaysToOffload](https://100daystooffload.com/).\n","frontmatter":{"title":"Fixing Traefik Proxy Issues","date":"2022-03-18","tags":"note, guide, infrastructure, web, 100DaysToOffload, homelab, tech"},"tags":["note","guide","infrastructure","web","100DaysToOffload","homelab","tech"]},"recommendedPosts":[{"slug":"2024-01-18-cost-per-request","frontmatter":{"title":"Cost per Request","date":"2024-01-18","tags":"infrastructure, aws, note, opinion, devops, tech"},"tags":["infrastructure","aws","note","opinion","devops","tech"]},{"slug":"2024-01-06-a-better-publishing-workflow-for-static-blogs","frontmatter":{"title":"A better publishing workflow for static blogs","date":"2024-01-06","tags":"guide, note, meta, writing, web, github, tech"},"tags":["guide","note","meta","writing","web","github","tech"]},{"slug":"2024-01-05-greg-the-developer","frontmatter":{"title":"Greg, the Developer","date":"2024-01-05","tags":"note, tech, fun, shortstory, writing, programming, practices, devops"},"tags":["note","tech","fun","shortstory","writing","programming","practices","devops"]},{"slug":"2023-12-28-linkdump-2","frontmatter":{"title":"Linkdump #2","date":"2023-12-28","tags":"note, tech, programming, linkdump"},"tags":["note","tech","programming","linkdump"]},{"slug":"2023-12-22-10-000-hours","frontmatter":{"title":"10.000 Hours","date":"2023-12-22","tags":"100DaysToOffload, note, learnings, books, tech, programming"},"tags":["100DaysToOffload","note","learnings","books","tech","programming"]}]},"__N_SSG":true},"page":"/posts/[post]","query":{"post":"2022-03-18-fix-traefik-proxy-issues"},"buildId":"3DsOoiq6ySl39UExIPsH3","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>