<!DOCTYPE html><html><head><script async="" defer="" data-domain="garrit.xyz" src="https://analytics.slashdev.space/js/plausible.outbound-links.js"></script><script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>Fixing Traefik Proxy Issues</title><meta name="Description" content="Generalist developer writing about fullstack development, system administration and free software."/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="webmention" href="https://webmention.io/garrit.xyz/webmention"/><link rel="pingback" href="https://webmention.io/garrit.xyz/xmlrpc"/><meta name="next-head-count" content="9"/><link rel="preload" href="https://garrit.xyz/_next/static/css/8e7046d3ef6ac6d8.css" as="style"/><link rel="stylesheet" href="https://garrit.xyz/_next/static/css/8e7046d3ef6ac6d8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="https://garrit.xyz/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="https://garrit.xyz/_next/static/chunks/webpack-419417af898ef431.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/main-01df828e572375b9.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/pages/_app-6297bfd2dcc78ba7.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/988-48b55eebb161e8d8.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/746-6cb8fd2335c400fd.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/768-d1db3457a00e9fa7.js" defer=""></script><script src="https://garrit.xyz/_next/static/chunks/pages/posts/%5Bpost%5D-204e11083399f3a3.js" defer=""></script><script src="https://garrit.xyz/_next/static/rruxXOdxHEWAW_hXl6L7d/_buildManifest.js" defer=""></script><script src="https://garrit.xyz/_next/static/rruxXOdxHEWAW_hXl6L7d/_ssgManifest.js" defer=""></script><script src="https://garrit.xyz/_next/static/rruxXOdxHEWAW_hXl6L7d/_middlewareManifest.js" defer=""></script><style id="__jsx-8946a52cf42f2313">.layout.jsx-8946a52cf42f2313{overflow-x:hidden;
display:-webkit-box;
display:-webkit-flex;
display:-ms-flexbox;
display:flex;
-webkit-flex-direction:column;
-ms-flex-direction:column;
flex-direction:column;
min-height:100vh}
.layout.jsx-8946a52cf42f2313 .info_page.jsx-8946a52cf42f2313{color:#ebebeb}
.content.jsx-8946a52cf42f2313{}
@media (min-width:768px) {}</style></head><body><div id="__next" data-reactroot=""><section class="jsx-8946a52cf42f2313 layout"><header class="header"><nav class="nav" role="navigation" aria-label="main navigation"><div class="header__container"><a href="/" class="header__container__logo underlined">Garrit&#x27;s Notes</a></div><ul class="header__links"><li><a href="/posts" class="underlined">Blog</a></li><li><a href="/contact" class="underlined">Contact</a></li><li><a href="/cv" class="underlined">Resume</a></li></ul></nav></header><div class="jsx-8946a52cf42f2313 content"><article class="page h-entry"><div class="page__info"><h1 class="p-name">Fixing Traefik Proxy Issues</h1><h3 class="page__info__date">Mar 18 2022</h3></div><div class="page__body e-content"><p>After changing my proxy from NGINX to Traefik, I noticed that some of my
services started misbehaving.</p>
<p>In particular, my instance of
<a href="https://github.com/NicolasConstant/BirdsiteLive">BirdsiteLive</a>
(<a href="https://birdsite.slashdev.space">birdsite.slashdev.space</a>) had issues
forwarding tweets to the
<a href="https://garrit.xyz/posts/2021-01-18-reasons-the-fediverse-is-better">Fediverse</a>.</p>
<p>The only difference between my old NGINX and my Traefik config were the headers.
I didn&#x27;t think that that&#x27;s what&#x27;s causing the issue, but after digging around a
bit I figured out what&#x27;s wrong. I still can&#x27;t wrap my head around it entirely,
but it has something to do with forwarding external <code>https</code> requests to internal
<code>http</code> services, since the <code>x-forwarded-</code> headers where missing in the forwarded
requests.</p>
<p>In the world of NGINX, we can instruct the proxy to forward <em>all</em> headers using
this directive:</p>
<pre><code class="language-conf">proxy_pass_request_headers      on;
</code></pre>
<p>which takes care of the issue. In Traefik, it&#x27;s a bit more convoluted. Traefik
can use a combination of &quot;Entrypoints&quot; and middleware to route traffic around.
In my setup, I use a <code>webSecure</code> entrypoint listening for SSL/TLS traffic, and a
<code>web</code> entrypoint that just redirects to <code>webSecure</code>:</p>
<pre><code class="language-yaml">entryPoints:
    web:
        address: :80
        http:
            redirections:
                entryPoint:
                    to: &quot;websecure&quot;
                    scheme: &quot;https&quot;

    websecure:
        address: :443
</code></pre>
<p>Apparently, some services send requests to the <code>web</code> entrypoint, and the
<code>x-forwarded-for</code> headers are dropped. To prevent this, you can set the
<code>proxyProtocol</code> and <code>forwardedHeaders</code> in the <code>web</code> entrypoint to <code>insecure</code>,
like so:</p>
<pre><code class="language-yaml">entryPoints:
    web:
        address: :80
        proxyProtocol:
            insecure: true
        forwardedHeaders:
            insecure: true
        # ...
# ...
</code></pre>
<p>I&#x27;m sure there&#x27;s a reason why this is marked as <code>insecure</code>, but it behaves just
like the NGINX counterpart, so I didn&#x27;t bother digging deeper into the matter.
Maybe one day I&#x27;ll come back to properly fix this.</p>
<p>If you want to read more, check out
<a href="https://medium.com/@_jonas/traefik-kubernetes-ingress-and-x-forwarded-headers-82194d319b0e">this</a>
article on Medium. It explains the issue in more detail.</p>
<hr/>
<p>This is post 025 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p><hr/><p><a href="mailto:garrit@slashdev.space?subject=Re: Fixing%20Traefik%20Proxy%20Issues">Reply via E-Mail</a></p><div class="page__tag-list"><svg class="page__tag-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><a href="/posts?tags=note">#<!-- -->note</a><a href="/posts?tags=guide">#<!-- -->guide</a><a href="/posts?tags=infrastructure">#<!-- -->infrastructure</a><a href="/posts?tags=web">#<!-- -->web</a><a href="/posts?tags=100DaysToOffload">#<!-- -->100DaysToOffload</a></div></div></article></div><footer class="footer"><div class="footer__content"><section class="footer__content__links"><h3>Links of Interest</h3><a href="/rss.xml">RSS Feed</a><br/><a href="/todo">Todo List</a><br/><a href="https://keyoxide.org/hkp/garrit@slashdev.space">PGP Key</a><br/><a href="/blogroll">Blogroll</a></section><section class="footer__content__social"><h3>Elsewhere</h3><a href="https://github.com/garritfra" rel="me">Github</a><br/><a href="https://www.linkedin.com/in/garritfranke/">LinkedIn</a><br/><a href="https://fosstodon.org/@garritfra">Mastodon (ActivityPub)</a><br/><a href="/contact">Contact</a></section></div><p>Â© 2018-2022 Garrit Franke</p></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Fixing Traefik Proxy Issues","date":"2022-03-18","tags":"note, guide, infrastructure, web, 100DaysToOffload"},"markdownBody":"\nAfter changing my proxy from NGINX to Traefik, I noticed that some of my\nservices started misbehaving.\n\nIn particular, my instance of\n[BirdsiteLive](https://github.com/NicolasConstant/BirdsiteLive)\n([birdsite.slashdev.space](https://birdsite.slashdev.space)) had issues\nforwarding tweets to the\n[Fediverse](https://garrit.xyz/posts/2021-01-18-reasons-the-fediverse-is-better).\n\nThe only difference between my old NGINX and my Traefik config were the headers.\nI didn't think that that's what's causing the issue, but after digging around a\nbit I figured out what's wrong. I still can't wrap my head around it entirely,\nbut it has something to do with forwarding external `https` requests to internal\n`http` services, since the `x-forwarded-` headers where missing in the forwarded\nrequests.\n\nIn the world of NGINX, we can instruct the proxy to forward _all_ headers using\nthis directive:\n\n```conf\nproxy_pass_request_headers      on;\n```\n\nwhich takes care of the issue. In Traefik, it's a bit more convoluted. Traefik\ncan use a combination of \"Entrypoints\" and middleware to route traffic around.\nIn my setup, I use a `webSecure` entrypoint listening for SSL/TLS traffic, and a\n`web` entrypoint that just redirects to `webSecure`:\n\n```yaml\nentryPoints:\n    web:\n        address: :80\n        http:\n            redirections:\n                entryPoint:\n                    to: \"websecure\"\n                    scheme: \"https\"\n\n    websecure:\n        address: :443\n```\n\nApparently, some services send requests to the `web` entrypoint, and the\n`x-forwarded-for` headers are dropped. To prevent this, you can set the\n`proxyProtocol` and `forwardedHeaders` in the `web` entrypoint to `insecure`,\nlike so:\n\n```yaml\nentryPoints:\n    web:\n        address: :80\n        proxyProtocol:\n            insecure: true\n        forwardedHeaders:\n            insecure: true\n        # ...\n# ...\n```\n\nI'm sure there's a reason why this is marked as `insecure`, but it behaves just\nlike the NGINX counterpart, so I didn't bother digging deeper into the matter.\nMaybe one day I'll come back to properly fix this.\n\nIf you want to read more, check out\n[this](https://medium.com/@_jonas/traefik-kubernetes-ingress-and-x-forwarded-headers-82194d319b0e)\narticle on Medium. It explains the issue in more detail.\n\n---\n\nThis is post 025 of [#100DaysToOffload](https://100daystooffload.com/).\n"},"__N_SSG":true},"page":"/posts/[post]","query":{"post":"2022-03-18-fix-traefik-proxy-issues"},"buildId":"rruxXOdxHEWAW_hXl6L7d","assetPrefix":"https://garrit.xyz","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>