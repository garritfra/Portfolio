{"pageProps":{"post":{"slug":"2022-05-31-database-server-migration-cheat-sheet","markdownBody":"\nI just finished migrating a postgres database to a new host. To remember how to\ndo it next time, I'm writing down the commands I used here.\n\nI usually just shut down the database and then copy the local directory where\nthe volume was mounted onto the new host. This time though, I seemed to be\ngetting some I/O errors, so I had to do it the \"right\" way.\n\nTo be fair, this note is based on\n[this](https://www.netguru.com/blog/how-to-dump-and-restore-postgresql-database)\nguide. I modified it to fit my workflow with docker.\n\n## Creating a dump\n\nLog into the old host:\n\n```\nssh <user>@host\n```\n\nConnect to the postgres-container:\n\n```\ndocker exec -ti myservice_db_1 /bin/bash\n```\n\nCreate a dump. You can name your dump as you wish - I'm using dates to\ndistinguish multiple dumps:\n\n```\npg_dump -U db_user db_name > db_name_20220531.sql\n```\n\nCopy the dump to the host machine:\n\n```\ndocker cp myservice_db_1:/db_name_20220531.sql ~/\n```\n\n## Moving the dump to the new host\n\nThe easiest way to get the dump off of the old server and onto the new one is to\nuse your local machine as a middleman.\n\nFirst, download the dump to your machine:\n\n```\nscp <user>@<host>:~/db_name_20220531.sql .\n```\n\nThen, do the same thing but reversed, with the new host:\n\n```\nscp ./db_name_20220531.sql <user>@<host>:~/\n```\n\n## Restoring the dump\n\nFirst, connect to the new host:\n\n```\nssh <user>@<host>\n```\n\nAssuming the docker service is already running on the new host, attach to the\ndb-container, just like above:\n\n```\ndocker exec -ti myservice_db_1 /bin/bash\n```\n\nThis time, we have to do some fiddling on the database, so attach a session to\npostgres using their cli:\n\n```\npsql -U my_user\n```\n\nBefore \"resetting\" the existing DB to apply the dump, we have to connect to\nanother database. The `postgres` DB is always there, so you can use that.\n\n```\n\\c postgres\n```\n\nNow, we drop the existing DB and re-add it:\n\n```sql\ndrop database database_name;\ncreate database database_name with owner your_user_name;\n```\n\nAnd now, the moment you've been waiting for! Leave the psql-session and apply\nthe dump:\n\n```\npsql -U db_user db_name < db_name_20220531.sql\n```\n\nThat's all! You now have the exact copy of production database available on your\nmachine.\n\nThis is post 032 of [#100DaysToOffload](https://100daystooffload.com/).\n","frontmatter":{"title":"Postgres Docker Container Migration Cheat Sheet","date":"2022-05-31","tags":"note, guide, 100DaysToOffload, database, docker, postgres, homelab, tech"},"tags":["note","guide","100DaysToOffload","database","docker","postgres","homelab","tech"]},"recommendedPosts":[{"slug":"2024-06-03-i-just-cleaned-up-40-gb-of-brew-caches","frontmatter":{"title":"I just cleaned up 40 GB of Brew caches","date":"2024-06-03","tags":"guide, note, tech"},"tags":["guide","note","tech"]},{"slug":"2024-05-24-going-from-self-hosted-to-managed-software","frontmatter":{"title":"Going from self hosted to managed software","date":"2024-05-24","tags":"infrastructure, note, learnings, opinion, homelab, tech"},"tags":["infrastructure","note","learnings","opinion","homelab","tech"]},{"slug":"2024-04-15-beware-of-base64-encoded-strings","frontmatter":{"title":"Beware of base64 encoded strings","date":"2024-04-15","tags":"guide, note, learnings, web, til, tech, programming"},"tags":["guide","note","learnings","web","til","tech","programming"]},{"slug":"2024-04-11-a-simple-search-bar","frontmatter":{"title":"A simple search bar","date":"2024-04-11","tags":"guide, note, meta, web, tech, programming"},"tags":["guide","note","meta","web","tech","programming"]},{"slug":"2024-04-04-pandoc-convert-links-to-footnotes-the-easy-way","frontmatter":{"title":"Pandoc: Convert links to footnotes (the easy way)","date":"2024-04-04","tags":"guide, note, writing, til, tech, programming, pandoc"},"tags":["guide","note","writing","til","tech","programming","pandoc"]}]},"__N_SSG":true}